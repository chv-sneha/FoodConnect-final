<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OCR Test - Food Package Analysis</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; margin-bottom: 20px; }
        .upload-area { border: 2px dashed #4CAF50; padding: 40px; text-align: center; border-radius: 8px; margin-bottom: 20px; cursor: pointer; }
        .upload-area:hover { background: #f9f9f9; }
        .upload-area.dragover { background: #e8f5e9; border-color: #2e7d32; }
        input[type="file"] { display: none; }
        .btn { background: #4CAF50; color: white; padding: 12px 30px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        .btn:hover { background: #45a049; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .preview { margin: 20px 0; text-align: center; }
        .preview img { max-width: 100%; max-height: 400px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .loading { display: none; text-align: center; padding: 20px; color: #666; }
        .loading.show { display: block; }
        .results { margin-top: 30px; }
        .result-section { margin-bottom: 25px; padding: 20px; background: #f9f9f9; border-radius: 8px; }
        .result-section h3 { color: #4CAF50; margin-bottom: 15px; }
        .raw-text { background: #fff; padding: 15px; border-left: 4px solid #4CAF50; white-space: pre-wrap; font-family: monospace; font-size: 14px; max-height: 300px; overflow-y: auto; }
        .nutrition-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; }
        .nutrition-item { background: white; padding: 10px; border-radius: 5px; }
        .nutrition-item strong { color: #333; }
        .ingredient-list { list-style: none; }
        .ingredient-list li { padding: 8px; background: white; margin-bottom: 5px; border-radius: 5px; }
        .allergen-badge { display: inline-block; background: #ff9800; color: white; padding: 5px 15px; border-radius: 20px; margin: 5px; }
        .error { background: #ffebee; color: #c62828; padding: 15px; border-radius: 5px; margin: 20px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç OCR Test - Food Package Analysis</h1>
        
        <div class="upload-area" id="uploadArea">
            <p>üìÅ Drag & Drop image here or click to select</p>
            <p style="color: #666; font-size: 14px; margin-top: 10px;">Supports: JPG, PNG, JPEG</p>
            <input type="file" id="fileInput" accept="image/*">
        </div>

        <div class="preview" id="preview"></div>

        <div class="loading" id="loading">
            <p>‚è≥ Processing image... Please wait...</p>
        </div>

        <div id="error"></div>
        <div id="results"></div>
    </div>

    <script>
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const preview = document.getElementById('preview');
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');
        const errorDiv = document.getElementById('error');

        uploadArea.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFile);

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                processImage(file);
            }
        });

        function handleFile(e) {
            const file = e.target.files[0];
            if (file) processImage(file);
        }

        function processImage(file) {
            // Show preview
            const reader = new FileReader();
            reader.onload = (e) => {
                preview.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
            };
            reader.readAsDataURL(file);

            // Show loading
            loading.classList.add('show');
            results.innerHTML = '';
            errorDiv.innerHTML = '';

            // Send to API
            const formData = new FormData();
            formData.append('image', file);

            fetch('http://localhost:5000/api/ocr/analyze', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                loading.classList.remove('show');
                if (data.error) {
                    showError(data.error);
                } else {
                    displayResults(data);
                }
            })
            .catch(error => {
                loading.classList.remove('show');
                showError('Failed to connect to OCR server. Make sure the API server is running on port 5000.');
            });
        }

        function showError(message) {
            errorDiv.innerHTML = `<div class="error">‚ùå Error: ${message}</div>`;
        }

        function displayResults(data) {
            let html = '<div class="results">';

            // Raw Text
            html += `
                <div class="result-section">
                    <h3>üìÑ Raw Extracted Text</h3>
                    <div class="raw-text">${data.raw_text || 'No text extracted'}</div>
                </div>
            `;

            // Nutrition Facts
            html += `<div class="result-section">
                <h3>üìä Nutrition Facts</h3>`;
            if (data.serving_size) {
                html += `<p><strong>Serving Size:</strong> ${data.serving_size}</p><br>`;
            }
            if (Object.keys(data.nutrition_facts).length > 0) {
                html += '<div class="nutrition-grid">';
                for (const [key, value] of Object.entries(data.nutrition_facts)) {
                    html += `<div class="nutrition-item"><strong>${key}:</strong> ${value}</div>`;
                }
                html += '</div>';
            } else {
                html += '<p>No nutrition facts detected</p>';
            }
            html += '</div>';

            // Ingredients
            html += `<div class="result-section">
                <h3>ü•ò Ingredients</h3>`;
            if (data.ingredients.length > 0) {
                html += '<ul class="ingredient-list">';
                data.ingredients.forEach(ing => {
                    html += `<li>${ing}</li>`;
                });
                html += '</ul>';
            } else {
                html += '<p>No ingredients detected</p>';
            }
            html += '</div>';

            // Allergens
            html += `<div class="result-section">
                <h3>‚ö†Ô∏è Allergens</h3>`;
            if (data.allergens.length > 0) {
                data.allergens.forEach(allergen => {
                    html += `<span class="allergen-badge">${allergen}</span>`;
                });
            } else {
                html += '<p>No allergens detected</p>';
            }
            html += '</div>';

            html += '</div>';
            results.innerHTML = html;
        }
    </script>
</body>
</html>
